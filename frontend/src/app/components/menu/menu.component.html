<div class="grid">
    <div class="col-12 md:col-8">
        <div class="card">
            <!-- Search and Layout Controls -->
            <div class="flex justify-content-between mb-3">
                <span class="p-input-icon-left">
                    <i class="pi pi-search"></i>
                    <input type="search" pInputText placeholder="Buscar producto..."
                        (input)="filterProducts($any($event.target).value)">
                </span>
                <div class="flex gap-2">
                    <button pButton icon="pi pi-list" class="p-button-outlined" (click)="layout = 'list'"
                        [class.p-button-secondary]="layout !== 'list'"></button>
                    <button pButton icon="pi pi-th-large" class="p-button-outlined" (click)="layout = 'grid'"
                        [class.p-button-secondary]="layout !== 'grid'"></button>
                </div>
            </div>

            <!-- Category Filter Chips -->
            <div class="flex gap-2 mb-3 flex-wrap">
                <button *ngFor="let cat of categories" pButton [label]="cat" (click)="filterByCategory(cat)"
                    [class]="selectedCategory === cat ? 'p-button-sm' : 'p-button-sm p-button-outlined'"
                    class="category-chip">
                </button>
            </div>

            <!-- Products Display -->
            <div *ngFor="let group of groupedProducts" class="mb-4">
                <h4 class="mb-2">{{group.name}}</h4>
                <p-dataView [value]="group.products" [layout]="layout">
                    <ng-template let-product pTemplate="gridItem">
                        <div class="col-12 md:col-6 lg:col-4">
                            <div class="product-grid-item card m-2">
                                <div class="product-grid-item-content">
                                    <div class="product-icon mb-2">
                                        <i class="pi pi-shopping-bag"
                                            style="font-size: 2rem; color: var(--primary-color)"></i>
                                    </div>
                                    <div class="product-name font-bold text-xl mb-2">{{product.name}}</div>
                                    <div class="product-description text-600 mb-3">{{product.description}}</div>
                                </div>
                                <div class="product-grid-item-bottom flex justify-content-between align-items-center">
                                    <span class="product-price text-2xl font-bold text-primary">{{product.price |
                                        currency:'MXN':'symbol':'1.2-2':'es-MX'}}</span>
                                    <p-button icon="pi pi-plus" (click)="openExtrasDialog(product)" label="Agregar"
                                        class="add-button"></p-button>
                                </div>
                            </div>
                        </div>
                    </ng-template>
                    <ng-template let-product pTemplate="listItem">
                        <div class="col-12">
                            <div class="flex flex-column xl:flex-row xl:align-items-start p-4 gap-4 card m-2">
                                <div
                                    class="flex flex-column sm:flex-row justify-content-between align-items-center xl:align-items-start flex-1 gap-4">
                                    <div class="flex flex-column align-items-center sm:align-items-start gap-3">
                                        <div class="text-2xl font-bold text-900">{{ product.name }}</div>
                                        <div class="flex align-items-center gap-3">
                                            <span class="flex align-items-center gap-2">
                                                <i class="pi pi-tag"></i>
                                                <span class="font-semibold">{{ product.category }}</span>
                                            </span>
                                        </div>
                                        <div class="text-700">{{ product.description }}</div>
                                    </div>
                                    <div
                                        class="flex sm:flex-column align-items-center sm:align-items-end gap-3 sm:gap-2">
                                        <span class="text-2xl font-semibold text-primary">{{ product.price |
                                            currency:'MXN':'symbol':'1.2-2':'es-MX'
                                            }}</span>
                                        <button pButton icon="pi pi-plus" label="Agregar" class="p-button-lg"
                                            (click)="openExtrasDialog(product)"></button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </ng-template>
                </p-dataView>
                <p-divider></p-divider>
            </div>
        </div>
    </div>

    <!-- Order Panel -->
    <div class="col-12 md:col-4">
        <div class="card order-panel">
            <h5 class="mb-3">Pedido Actual</h5>

            <!-- Customer Name Input -->
            <div class="p-fluid mb-3">
                <span class="p-float-label">
                    <input id="customerName" type="text" pInputText [(ngModel)]="customerName">
                    <label for="customerName">Nombre del Cliente</label>
                </span>
            </div>

            <!-- Order Items -->
            <div *ngIf="orderItems.length > 0" class="order-items-container">
                <p-table [value]="orderItems" [scrollable]="true" scrollHeight="400px">
                    <ng-template pTemplate="header">
                        <tr>
                            <th>Producto</th>
                            <th style="width: 120px">Cant.</th>
                            <th style="width: 100px">Total</th>
                            <th style="width: 50px"></th>
                        </tr>
                    </ng-template>
                    <ng-template pTemplate="body" let-item>
                        <tr>
                            <td>
                                <div class="font-semibold">{{item.product.name}}</div>
                                <div *ngIf="item.extras && item.extras.length > 0" class="text-sm text-500">
                                    <span *ngFor="let extra of item.extras; let last = last">
                                        + {{extra.name}}{{!last ? ', ' : ''}}
                                    </span>
                                </div>
                            </td>
                            <td>
                                <div class="flex align-items-center gap-2">
                                    <button pButton icon="pi pi-minus"
                                        class="p-button-rounded p-button-text p-button-sm"
                                        (click)="updateQuantity(item, -1)"></button>
                                    <span class="font-bold text-lg">{{item.quantity}}</span>
                                    <button pButton icon="pi pi-plus" class="p-button-rounded p-button-text p-button-sm"
                                        (click)="updateQuantity(item, 1)"></button>
                                </div>
                            </td>
                            <td class="font-semibold">
                                {{ getItemTotal(item) | currency:'MXN':'symbol':'1.2-2':'es-MX' }}
                            </td>
                            <td>
                                <button pButton icon="pi pi-trash"
                                    class="p-button-rounded p-button-danger p-button-text p-button-sm"
                                    (click)="removeItem(item)"></button>
                            </td>
                        </tr>
                    </ng-template>
                </p-table>

                <!-- Order Total -->
                <div class="order-total mt-3 p-3 surface-100 border-round">
                    <div class="flex justify-content-between align-items-center">
                        <span class="text-xl font-bold">TOTAL:</span>
                        <span class="text-3xl font-bold text-primary">{{ getOrderTotal() |
                            currency:'MXN':'symbol':'1.2-2':'es-MX' }}</span>
                    </div>
                </div>

                <!-- Action Buttons -->
                <div class="p-fluid mt-3">
                    <button pButton label="Enviar a Cocina" icon="pi pi-send" class="mb-2 p-button-lg p-button-success"
                        (click)="sendOrder()"
                        [disabled]="orderItems.length === 0 || (currentOrder && currentOrder.status !== 'OPEN' && currentOrder.status !== 'REOPENED')">
                    </button>

                    <div class="grid" *ngIf="currentOrder && currentOrder.id">
                        <div class="col-6">
                            <button pButton label="Entregar" icon="pi pi-check" class="p-button-info"
                                (click)="updateStatus(OrderStatus.DELIVERED)"
                                [disabled]="currentOrder.status !== 'OPEN' && currentOrder.status !== 'REOPENED'"></button>
                        </div>
                        <div class="col-6">
                            <button pButton label="Reabrir" icon="pi pi-refresh" class="p-button-warning"
                                (click)="updateStatus(OrderStatus.REOPENED)"
                                [disabled]="currentOrder.status !== 'DELIVERED'"></button>
                        </div>
                        <div class="col-12">
                            <button pButton label="Pagar y Cerrar" icon="pi pi-dollar" class="p-button-success"
                                (click)="updateStatus(OrderStatus.PAID)"
                                [disabled]="currentOrder.status === 'PAID'"></button>
                        </div>
                    </div>

                    <button pButton label="Cancelar Pedido" icon="pi pi-times"
                        class="mt-2 p-button-danger p-button-outlined" (click)="clearOrder()"
                        [disabled]="orderItems.length === 0">
                    </button>
                </div>
            </div>

            <!-- Empty State -->
            <div *ngIf="orderItems.length === 0" class="empty-order text-center p-5">
                <i class="pi pi-shopping-cart text-6xl text-400 mb-3"></i>
                <p class="text-600 text-lg">No hay items en el pedido</p>
                <p class="text-500">Agrega productos del men√∫ para comenzar</p>
            </div>
        </div>
    </div>
</div>

<!-- Extras Dialog -->
<p-dialog header="Seleccionar Extras" [(visible)]="extrasDialog" [modal]="true" [style]="{width: '50vw'}">
    <div class="flex flex-column gap-2" *ngIf="extras.length > 0">
        <div *ngFor="let extra of extras" class="field-checkbox">
            <p-checkbox name="group" [value]="extra" [(ngModel)]="selectedExtras"
                [inputId]="'extra' + extra.id"></p-checkbox>
            <label [for]="'extra' + extra.id" class="ml-2">{{extra.name}} (+${{extra.price}})</label>
        </div>
    </div>
    <div *ngIf="extras.length === 0">No hay extras disponibles.</div>
    <ng-template pTemplate="footer">
        <p-button icon="pi pi-check" (click)="confirmExtras()" label="Confirmar" styleClass="p-button-text"></p-button>
    </ng-template>
</p-dialog>

<p-toast></p-toast>