<div class="card">
    <h2>Historial de Pedidos</h2>
    <p-table [value]="orders">
        <ng-template pTemplate="header">
            <tr>
                <th>ID Pedido</th>
                <th>Cliente</th>
                <th>Fecha</th>
                <th>Estado</th>
                <th>Total</th>
                <th>Acciones</th>
            </tr>
        </ng-template>
        <ng-template pTemplate="body" let-order>
            <tr>
                <td>{{order.id}}</td>
                <td>{{order.customerName}}</td>
                <td>{{order.date | date:'short':'':'es-MX'}}</td>
                <td><span
                        [class]="'order-badge status-' + (order.status ? order.status.toLowerCase() : '')">{{order.status}}</span>
                </td>
                <td>{{order.total | currency:'MXN':'symbol':'1.2-2':'es-MX'}}</td>
                <td>
                    <button pButton icon="pi pi-search" label="Ver Detalles" (click)="showDetails(order)"
                        class="p-button-text mr-2"></button>
                    <button pButton icon="pi pi-trash" (click)="confirmDelete(order)"
                        class="p-button-text p-button-danger" pTooltip="Borrar Pedido"></button>
                </td>
            </tr>
        </ng-template>
    </p-table>
</div>

<p-dialog header="Borrar Pedido" [(visible)]="deleteDialogVisible" [modal]="true" [style]="{width: '350px'}">
    <div class="flex flex-column gap-2">
        <label for="reason">Motivo de la cancelación (obligatorio)</label>
        <textarea id="reason" pInputTextarea [(ngModel)]="deletionReason" rows="3"
            placeholder="Ingrese el motivo aquí..."></textarea>
    </div>
    <ng-template pTemplate="footer">
        <p-button label="Cancelar" icon="pi pi-times" (click)="deleteDialogVisible = false"
            styleClass="p-button-text"></p-button>
        <p-button label="Confirmar Borrado" icon="pi pi-check" (click)="executeDelete()"
            styleClass="p-button-danger"></p-button>
    </ng-template>
</p-dialog>

<p-dialog header="Detalles del Pedido" [(visible)]="dialogVisible" [modal]="true" [style]="{width: '50vw'}"
    [draggable]="false" [resizable]="false">
    <div *ngIf="selectedOrder">
        <div class="grid">
            <div class="col-6">
                <strong>Cliente:</strong> {{selectedOrder.customerName}}
            </div>
            <div class="col-6">
                <strong>ID Pedido:</strong> {{selectedOrder.id}}
            </div>
            <div class="col-6">
                <strong>Estado:</strong> {{selectedOrder.status}}
            </div>
            <div class="col-6">
                <strong>Fecha:</strong> {{selectedOrder.date | date:'short':'':'es-MX'}}
            </div>
        </div>
        <p-divider></p-divider>
        <p-table [value]="selectedOrder.items" [scrollable]="true" scrollHeight="200px">
            <ng-template pTemplate="header">
                <tr>
                    <th>Producto</th>
                    <th>Extras</th>
                    <th>Cant</th>
                    <th>Precio</th>
                </tr>
            </ng-template>
            <ng-template pTemplate="body" let-item>
                <tr>
                    <td>{{item.product.name}}</td>
                    <td>
                        <span *ngFor="let extra of item.extras; let last = last">
                            {{extra.name}}{{!last ? ', ' : ''}}
                        </span>
                    </td>
                    <td>{{item.quantity}}</td>
                    <td>{{item.product.price | currency:'MXN':'symbol':'1.2-2':'es-MX'}}</td>
                </tr>
            </ng-template>
        </p-table>
        <div class="flex justify-content-end mt-3">
            <h3>Total: {{selectedOrder.total | currency:'MXN':'symbol':'1.2-2':'es-MX'}}</h3>
        </div>
    </div>
    <ng-template pTemplate="footer">
        <p-button *ngIf="selectedOrder && (selectedOrder.status === 'OPEN' || selectedOrder.status === 'REOPENED')"
            icon="pi pi-pencil" (click)="editOrder(selectedOrder)" label="Editar Pedido"
            styleClass="p-button-warning mr-2"></p-button>
        <p-button *ngIf="selectedOrder" icon="pi pi-trash" (click)="confirmDelete(selectedOrder)" label="Borrar"
            styleClass="p-button-danger mr-2"></p-button>
        <p-button icon="pi pi-check" (click)="dialogVisible = false" label="Cerrar"
            styleClass="p-button-text"></p-button>
    </ng-template>
</p-dialog>