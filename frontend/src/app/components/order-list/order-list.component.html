<div class="card shadow-3 border-round-xl">
    <div class="flex justify-content-between align-items-center mb-4">
        <h2 class="m-0 text-primary flex align-items-center gap-2">
            <i class="pi pi-history"></i>
            Historial de Pedidos
        </h2>
    </div>

    <p-table [value]="orders" [paginator]="true" [rows]="10" responsiveLayout="stack" breakpoint="960px"
        styleClass="p-datatable-responsive-stack" [rowHover]="true">
        <ng-template pTemplate="header">
            <tr>
                <th pSortableColumn="id">ID <p-sortIcon field="id"></p-sortIcon></th>
                <th pSortableColumn="customerName">Cliente <p-sortIcon field="customerName"></p-sortIcon></th>
                <th pSortableColumn="date">Fecha <p-sortIcon field="date"></p-sortIcon></th>
                <th>Estado</th>
                <th pSortableColumn="total">Total <p-sortIcon field="total"></p-sortIcon></th>
                <th class="text-center">Acciones</th>
            </tr>
        </ng-template>
        <ng-template pTemplate="body" let-order>
            <tr class="transition-all duration-200">
                <td><span class="p-column-title">ID</span>#{{order.id}}</td>
                <td><span class="p-column-title">Cliente</span>{{order.customerName}}</td>
                <td><span class="p-column-title">Fecha</span>{{order.date | date:'short':'':'es-MX'}}</td>
                <td>
                    <span class="p-column-title">Estado</span>
                    <span [class]="'order-badge status-' + (order.status ? order.status.toLowerCase() : '')">
                        {{order.status}}
                    </span>
                </td>
                <td>
                    <span class="p-column-title">Total</span>
                    <span class="font-bold text-primary">{{order.total | currency:'MXN'}}</span>
                </td>
                <td class="text-center">
                    <span class="p-column-title">Acciones</span>
                    <div class="flex justify-content-center gap-2">
                        <button pButton icon="pi pi-search" pTooltip="Ver Detalles" tooltipPosition="top"
                            (click)="showDetails(order)" class="p-button-rounded p-button-text p-button-info"></button>
                        <button pButton icon="pi pi-print" pTooltip="Imprimir Ticket" tooltipPosition="top"
                            (click)="printTicket(order)"
                            class="p-button-rounded p-button-text p-button-success"></button>
                        <button pButton icon="pi pi-trash" pTooltip="Borrar Pedido" tooltipPosition="top"
                            (click)="confirmDelete(order)"
                            class="p-button-rounded p-button-text p-button-danger"></button>
                    </div>
                </td>
            </tr>
        </ng-template>
        <ng-template pTemplate="emptymessage">
            <tr>
                <td colspan="6" class="text-center p-5 text-600">No se encontraron pedidos.</td>
            </tr>
        </ng-template>
    </p-table>
</div>

<p-dialog header="Borrar Pedido" [(visible)]="deleteDialogVisible" [modal]="true" [style]="{width: '350px'}">
    <div class="flex flex-column gap-2">
        <label for="reason">Motivo de la cancelación (obligatorio)</label>
        <textarea id="reason" pInputTextarea [(ngModel)]="deletionReason" rows="3"
            placeholder="Ingrese el motivo aquí..."></textarea>
    </div>
    <ng-template pTemplate="footer">
        <p-button label="Cancelar" icon="pi pi-times" (click)="deleteDialogVisible = false"
            styleClass="p-button-text"></p-button>
        <p-button label="Confirmar Borrado" icon="pi pi-check" (click)="executeDelete()"
            styleClass="p-button-danger"></p-button>
    </ng-template>
</p-dialog>

<p-dialog header="Detalles del Pedido" [(visible)]="dialogVisible" [modal]="true" [style]="{width: '50vw'}"
    [draggable]="false" [resizable]="false">
    <div *ngIf="selectedOrder">
        <div class="grid">
            <div class="col-6">
                <strong>Cliente:</strong> {{selectedOrder.customerName}}
            </div>
            <div class="col-6">
                <strong>ID Pedido:</strong> {{selectedOrder.id}}
            </div>
            <div class="col-6">
                <strong>Estado:</strong> {{selectedOrder.status}}
            </div>
            <div class="col-6">
                <strong>Fecha:</strong> {{selectedOrder.date | date:'short':'':'es-MX'}}
            </div>
        </div>
        <p-divider></p-divider>
        <p-table [value]="selectedOrder.items" [scrollable]="true" scrollHeight="200px">
            <ng-template pTemplate="header">
                <tr>
                    <th>Producto</th>
                    <th>Extras</th>
                    <th>Cant</th>
                    <th>Precio</th>
                </tr>
            </ng-template>
            <ng-template pTemplate="body" let-item>
                <tr>
                    <td>{{item.product.name}}</td>
                    <td>
                        <span *ngFor="let extra of item.extras; let last = last">
                            {{extra.name}}{{!last ? ', ' : ''}}
                        </span>
                    </td>
                    <td>{{item.quantity}}</td>
                    <td>{{item.product.price | currency:'MXN':'symbol':'1.2-2':'es-MX'}}</td>
                </tr>
            </ng-template>
        </p-table>
        <div class="flex justify-content-end mt-3">
            <h3>Total: {{selectedOrder.total | currency:'MXN':'symbol':'1.2-2':'es-MX'}}</h3>
        </div>
    </div>
    <ng-template pTemplate="footer">
        <p-button *ngIf="selectedOrder" icon="pi pi-print" (click)="printTicket(selectedOrder)" label="Imprimir"
            styleClass="p-button-success mr-2"></p-button>
        <p-button *ngIf="selectedOrder && (selectedOrder.status === 'OPEN' || selectedOrder.status === 'REOPENED')"
            icon="pi pi-pencil" (click)="editOrder(selectedOrder)" label="Editar Pedido"
            styleClass="p-button-warning mr-2"></p-button>
        <p-button *ngIf="selectedOrder" icon="pi pi-trash" (click)="confirmDelete(selectedOrder)" label="Borrar"
            styleClass="p-button-danger mr-2"></p-button>
        <p-button icon="pi pi-check" (click)="dialogVisible = false" label="Cerrar"
            styleClass="p-button-text"></p-button>
    </ng-template>
</p-dialog>